server {
        listen 443 ssl;
        server_name cleanapp.io www.cleanapp.io;

        ssl_certificate /etc/nginx/conf.d/STAR_cleanapp_io_chain.crt;
        ssl_certificate_key /etc/nginx/conf.d/STAR_cleanapp_io.key;
        ssl_session_cache shared:SSL:10m;

        # API v3 routes to report-listener (v3) on 9081
        location /api/v3/ {
                proxy_pass http://127.0.0.1:9081;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_read_timeout 86400;
        }

        # API v4 routes to report-listener-v4 on 9097
        location /api/v4/ {
                proxy_pass http://127.0.0.1:9097;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_read_timeout 86400;
        }

        # Next.js API routes - proxy to frontend
        location /api/reports/ {
                proxy_pass http://127.0.0.1:3001;
                proxy_set_header Host $host;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        }

        # Reports count - proxy to frontend Next.js API
        location /api/reports-count {
                proxy_pass http://127.0.0.1:3001;
                proxy_set_header Host $host;
        }

        # Geocode API - proxy to frontend Next.js API
        location /api/geocode {
                proxy_pass http://127.0.0.1:3001;
                proxy_set_header Host $host;
        }

        # Other legacy API routes to customer service
        location /api/ {
                proxy_pass http://127.0.0.1:9080;
                proxy_set_header Host $host;
        }

        # Public, secrets-safe uptime dashboard (served from VM-local watchdog artifacts).
        location = /uptime.json {
                alias /var/www/cleanapp_status/uptime.json;
                add_header Content-Type application/json;
                add_header Cache-Control "no-store";
        }
        location = /uptime {
                alias /var/www/cleanapp_status/uptime.html;
                add_header Cache-Control "no-store";
        }
        location = /uptime/ {
                return 301 /uptime;
        }

        location / {
                proxy_pass http://127.0.0.1:3001;
                proxy_set_header Host $host;
                proxy_redirect http:// https://;
        }
}
