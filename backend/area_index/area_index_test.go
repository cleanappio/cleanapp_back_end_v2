package area_index

import (
	"cleanapp/backend/server/api"
	"reflect"
	"testing"

	"github.com/golang/geo/s2"
	geojson "github.com/paulmach/go.geojson"
)

func TestUpdateOrCreateUser(t *testing.T) {
	testCases := []struct {
		name     string
		input    *api.Area
		expected []s2.CellID
	}{
		{
			name: "Small Polygon",
			input: &api.Area{
				Coordinates: &geojson.Feature{
					Geometry: &geojson.Geometry{
						Polygon: [][][]float64{
							{
								{175.4527356, -41.2149372},
								{175.4525347, -41.2147901},
								{175.4523615, -41.2146843},
								{175.450895, -41.2154755},
								{175.4517529, -41.2163586},
								{175.4522375, -41.2160895},
								{175.4519603, -41.2162412},
								{175.4522983, -41.2160563},
								{175.4524341, -41.2159776},
								{175.4518662, -41.2154027},
								{175.4527356, -41.2149372},
							},
						},
					},
				},
			},
			expected: []s2.CellID{
				0x6d472d6915400000,
				0x6d472d6923500000,
				0x6d472d6925000000,
				0x6d472d6931000000,
				0x6d472d6935000000,
				0x6d472d6937000000,
				0x6d472d6939000000,
				0x6d472d693b000000,
				0x6d472d693c400000,
				0x6d472d693cc00000,
				0x6d472d693dc00000,
				0x6d472d693f000000,
				0x6d472d6941000000,
				0x6d472d6942400000,
				0x6d472d6942c00000,
				0x6d472d6943d40000,
				0x6d472d6945c00000,
				0x6d472d6947000000,
				0x6d472d6949000000,
				0x6d472d694b000000,
				0x6d472d694c400000,
				0x6d472d694dd00000,
				0x6d472d694f000000,
				0x6d472d6951c00000,
				0x6d472d6961300000,
				0x6d472d69642c0000,
				0x6d472d6965c00000,
				0x6d472d6967000000,
				0x6d472d6969000000,
				0x6d472d696b000000,
				0x6d472d696ec00000,
				0x6d472d696f400000,
			},
		}, {
			name: "Large Polygon",
			input: &api.Area{
				Coordinates: &geojson.Feature{
					Geometry: &geojson.Geometry{
						Polygon: [][][]float64{
							{
								{43.0850536, 44.2185193},
								{43.0849661, 44.2185567},
								{43.0849402, 44.2185701},
								{43.0851314, 44.2187984},
								{43.0851563, 44.2187859},
								{43.0851165, 44.2187373},
								{43.0856697, 44.2185053},
								{43.0857336, 44.2185797},
								{43.0857035, 44.218593},
								{43.0857988, 44.2187039},
								{43.0857819, 44.2187113},
								{43.0858317, 44.2187693},
								{43.0859803, 44.2187071},
								{43.0859193, 44.2186328},
								{43.0857135, 44.2184026},
								{43.0858819, 44.2183253},
								{43.0860876, 44.2185556},
								{43.0861064, 44.2185725},
								{43.086368, 44.2184483},
								{43.0862126, 44.2182607},
								{43.0864663, 44.2181426},
								{43.0865188, 44.2181166},
								{43.0869454, 44.217976},
								{43.0873525, 44.2177944},
								{43.0869961, 44.217384},
								{43.0874333, 44.217189},
								{43.0876121, 44.217395},
								{43.0877832, 44.217592},
								{43.0886535, 44.2172039},
								{43.0887177, 44.2172779},
								{43.0886754, 44.2172967},
								{43.0886939, 44.2173181},
								{43.0887488, 44.2172815},
								{43.088356, 44.2168945},
								{43.0879813, 44.2164924},
								{43.0891712, 44.2159527},
								{43.0903623, 44.2153833},
								{43.0903376, 44.2153507},
								{43.0903044, 44.2153663},
								{43.0902884, 44.2153471},
								{43.0902676, 44.2153238},
								{43.0899581, 44.2149491},
								{43.0890271, 44.2138374},
								{43.0907516, 44.2130844},
								{43.091432, 44.213842},
								{43.0915601, 44.2138526},
								{43.0923202, 44.213484},
								{43.0927475, 44.2139783},
								{43.0927943, 44.2139841},
								{43.0935582, 44.2136327},
								{43.0943496, 44.213273},
								{43.095201, 44.2128889},
								{43.0952495, 44.2128743},
								{43.0964848, 44.2126178},
								{43.0965652, 44.2126042},
								{43.0966081, 44.2126445},
								{43.0967167, 44.2127633},
								{43.0968243, 44.2128848},
								{43.0980363, 44.2123461},
								{43.0981941, 44.2122718},
								{43.0984802, 44.2126177},
								{43.0990548, 44.2123594},
								{43.0997059, 44.2130784},
								{43.0997679, 44.213051},
								{43.09984, 44.2130217},
								{43.1005722, 44.2128294},
								{43.1015325, 44.2125391},
								{43.1078233, 44.2106266},
								{43.1087919, 44.2103363},
								{43.1088669, 44.2104487},
								{43.1121781, 44.2094679},
								{43.112154, 44.2094121},
								{43.1127116, 44.2092426},
								{43.1133531, 44.2091853},
								{43.1134295, 44.209184},
								{43.1153056, 44.2118201},
								{43.1157752, 44.2125236},
								{43.1144897, 44.2129071},
								{43.1150932, 44.2139644},
								{43.1133753, 44.2144371},
								{43.1132011, 44.2141935},
								{43.1126502, 44.2143382},
								{43.1126289, 44.2143869},
								{43.1128633, 44.2148236},
								{43.1131652, 44.2152498},
								{43.113664, 44.2160554},
								{43.1141069, 44.2177133},
								{43.1142204, 44.2179156},
								{43.1106508, 44.2189177},
								{43.1091996, 44.2189744},
								{43.1068911, 44.2190695},
								{43.1057783, 44.2191072},
								{43.1052785, 44.2191355},
								{43.1052472, 44.2191561},
								{43.1052812, 44.2191878},
								{43.1053128, 44.2192174},
								{43.1054532, 44.2191551},
								{43.1063389, 44.2191257},
								{43.1111523, 44.2189656},
								{43.1111811, 44.2190301},
								{43.1117872, 44.2188571},
								{43.1119964, 44.2192761},
								{43.1124993, 44.2202698},
								{43.1115306, 44.2205635},
								{43.1110492, 44.2207646},
								{43.1099395, 44.2216594},
								{43.109747, 44.221771},
								{43.1101289, 44.2222092},
								{43.1097328, 44.2223435},
								{43.1095807, 44.2224069},
								{43.1095403, 44.2224433},
								{43.1095275, 44.2224756},
								{43.1095086, 44.2225103},
								{43.1094957, 44.2225406},
								{43.1094176, 44.2227084},
								{43.1093188, 44.2227336},
								{43.1092805, 44.2227433},
								{43.1091874, 44.2229118},
								{43.1091754, 44.2229327},
								{43.1091252, 44.2229722},
								{43.1079508, 44.2234105},
								{43.1071897, 44.223701},
								{43.1067537, 44.2238783},
								{43.1065188, 44.2239729},
								{43.1035541, 44.2251354},
								{43.1017779, 44.2258227},
								{43.1013627, 44.2252729},
								{43.1012203, 44.2253183},
								{43.0990494, 44.222323},
								{43.1013814, 44.2211516},
								{43.1028898, 44.2203965},
								{43.1043671, 44.2196631},
								{43.1047286, 44.2194837},
								{43.1046971, 44.2194622},
								{43.1046547, 44.2194332},
								{43.1024782, 44.2205107},
								{43.1018604, 44.220842},
								{43.0990569, 44.2222301},
								{43.0988201, 44.2223447},
								{43.0984227, 44.2218473},
								{43.0946185, 44.2235741},
								{43.0940504, 44.2238233},
								{43.0935076, 44.2240657},
								{43.0926659, 44.2244509},
								{43.0926559, 44.2253989},
								{43.0926448, 44.2264576},
								{43.0886187, 44.2270088},
								{43.0880517, 44.2265582},
								{43.0879859, 44.2265576},
								{43.0870043, 44.2270143},
								{43.0864497, 44.227261},
								{43.0856116, 44.22765},
								{43.0848693, 44.2279821},
								{43.0842435, 44.2282533},
								{43.0836046, 44.2285459},
								{43.0826206, 44.2289942},
								{43.0816236, 44.2294422},
								{43.0801754, 44.2300888},
								{43.0775475, 44.2312808},
								{43.0780657, 44.2319337},
								{43.0759303, 44.232902},
								{43.0758851, 44.2328877},
								{43.0754336, 44.2322383},
								{43.0743198, 44.2327438},
								{43.0732519, 44.2332263},
								{43.0725541, 44.233535},
								{43.0718336, 44.2338603},
								{43.0692018, 44.2350479},
								{43.068603, 44.2353201},
								{43.0672082, 44.235962},
								{43.0655548, 44.2367276},
								{43.0653138, 44.2368377},
								{43.0642573, 44.2373248},
								{43.0630954, 44.237858},
								{43.0624647, 44.2381563},
								{43.0617127, 44.2384941},
								{43.0607724, 44.2389233},
								{43.0601844, 44.239198},
								{43.0595783, 44.2394789},
								{43.0589254, 44.2397767},
								{43.057723, 44.2403402},
								{43.0570697, 44.2418158},
								{43.054396, 44.2430133},
								{43.0511807, 44.2422478},
								{43.0499948, 44.2408653},
								{43.0504005, 44.2385199},
								{43.0525714, 44.2374772},
								{43.0534164, 44.2366171},
								{43.0539983, 44.2363137},
								{43.0544624, 44.2360081},
								{43.055039, 44.2356257},
								{43.0555674, 44.2352817},
								{43.0567074, 44.2347628},
								{43.0574959, 44.2344073},
								{43.0583256, 44.2340499},
								{43.0576182, 44.2325788},
								{43.0590541, 44.232072},
								{43.0603518, 44.2313924},
								{43.0608273, 44.2311479},
								{43.0609801, 44.2310815},
								{43.0611008, 44.2310748},
								{43.0612175, 44.2310796},
								{43.0613731, 44.231094},
								{43.0617365, 44.2311517},
								{43.0618197, 44.2311575},
								{43.0618787, 44.2311507},
								{43.061935, 44.2311334},
								{43.0620155, 44.231094},
								{43.0627021, 44.2307097},
								{43.0633064, 44.230386},
								{43.0629257, 44.2298267},
								{43.0634558, 44.2297545},
								{43.0634545, 44.2297112},
								{43.0639654, 44.2296882},
								{43.0642519, 44.229847},
								{43.0649656, 44.2294474},
								{43.0661193, 44.228805},
								{43.0665779, 44.228534},
								{43.0667925, 44.2283687},
								{43.0669551, 44.2282302},
								{43.0682983, 44.2274392},
								{43.068264, 44.2274074},
								{43.06954, 44.2266457},
								{43.0696305, 44.2267462},
								{43.0704054, 44.2263564},
								{43.0709043, 44.2260835},
								{43.0715373, 44.2257144},
								{43.0727148, 44.2251801},
								{43.0739272, 44.2246419},
								{43.0760783, 44.2236712},
								{43.0779719, 44.2228217},
								{43.077929, 44.221478},
								{43.0779129, 44.22106},
								{43.0779089, 44.2208812},
								{43.0779009, 44.2204141},
								{43.07788, 44.2199618},
								{43.0767319, 44.2199558},
								{43.0758398, 44.219975},
								{43.0755232, 44.2199815},
								{43.0754668, 44.2195366},
								{43.0754647, 44.2193268},
								{43.0754645, 44.2192919},
								{43.0755383, 44.2192699},
								{43.0756034, 44.2192564},
								{43.0759246, 44.2191967},
								{43.0755474, 44.2186815},
								{43.0753387, 44.2184346},
								{43.0757099, 44.2183054},
								{43.0764723, 44.2180329},
								{43.0762112, 44.2177107},
								{43.0767305, 44.2174821},
								{43.0778454, 44.2169657},
								{43.0787467, 44.2165586},
								{43.0795177, 44.2162033},
								{43.079626, 44.2161535},
								{43.0802777, 44.2158446},
								{43.0804612, 44.2157595},
								{43.080304, 44.2155804},
								{43.0812343, 44.2151493},
								{43.08225, 44.2146825},
								{43.0827228, 44.2151886},
								{43.0832593, 44.2157631},
								{43.0833779, 44.21589},
								{43.0837803, 44.2163166},
								{43.0840329, 44.216587},
								{43.0843772, 44.2169424},
								{43.0835815, 44.2173162},
								{43.0836925, 44.2174595},
								{43.0837485, 44.2175176},
								{43.0837761, 44.2175445},
								{43.0837972, 44.217568},
								{43.0845427, 44.2172307},
								{43.0846792, 44.2172667},
								{43.085006, 44.2173528},
								{43.0852327, 44.2176623},
								{43.0848458, 44.2178401},
								{43.0852213, 44.2182698},
								{43.0853474, 44.2184169},
								{43.0850536, 44.2185193},
							},
						},
					},
				},
			},
			expected: []s2.CellID{
				0x4057a30b00000000,
				0x4057a30d00000000,
				0x4057a31300000000,
				0x4057a31500000000,
				0x4057a34400000000,
				0x4057a34c00000000,
				0x4057a364c0000000,
				0x4057a36540000000,
				0x4057a36630000000,
				0x4057a36c00000000,
				0x4057a37400000000,
				0x4057a37900000000,
				0x4057a37b00000000,
				0x4057a382c0000000,
				0x4057a39940000000,
				0x4057a39bc0000000,
				0x4057a39d00000000,
				0x4057a39f00000000,
				0x4057bcb100000000,
				0x4057bcb300000000,
				0x4057bcb440000000,
				0x4057bcb4c0000000,
				0x4057bcb700000000,
			},
		},
	}

	for _, testCase := range testCases {
		areaIdx := AreaToIndex(testCase.input)
		if !reflect.DeepEqual(areaIdx, testCase.expected) {
			t.Errorf("%s: Failure in getting the area index; got: %v, want: %v", testCase.name, areaIdx, testCase.expected)
		}
	}
}
